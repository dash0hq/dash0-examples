mode: deployment
replicaCount: 1

image:
  repository: otel/opentelemetry-collector-contrib

resources:
  limits:
    memory: 256Mi
  requests:
    memory: 128Mi

extraEnvs:
  - name: DASH0_AUTH_TOKEN
    valueFrom:
      secretKeyRef:
        name: dash0-secrets
        key: dash0-authorization-token
  - name: DASH0_ENDPOINT_OTLP_GRPC_HOSTNAME
    valueFrom:
      secretKeyRef:
        name: dash0-secrets
        key: dash0-grpc-hostname
  - name: DASH0_ENDPOINT_OTLP_GRPC_PORT
    valueFrom:
      secretKeyRef:
        name: dash0-secrets
        key: dash0-grpc-port

presets:
  kubernetesAttributes:
    enabled: true

clusterRole:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["pods", "services", "endpoints"]
      verbs: ["get", "list", "watch"]

config:
  processors:
    batch: {}

    # Filter out health check traces to reduce noise
    filter/healthcheck:
      error_mode: ignore
      traces:
        span:
          - 'name == "GET /health"'
          - 'name == "GET /health http send"'
          - 'name == "GET /health http receive"'

  receivers:
    # OTLP receiver for traces from OpenLIT instrumented apps
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318

  exporters:
    otlp/dash0:
      auth:
        authenticator: bearertokenauth/dash0
      endpoint: ${env:DASH0_ENDPOINT_OTLP_GRPC_HOSTNAME}:${env:DASH0_ENDPOINT_OTLP_GRPC_PORT}

    otlphttp/openlit:
      endpoint: http://openlit.openlit.svc.cluster.local:4318

    # Debug exporter for local troubleshooting
    debug:
      verbosity: detailed

  extensions:
    bearertokenauth/dash0:
      scheme: Bearer
      token: ${env:DASH0_AUTH_TOKEN}

  service:
    extensions:
      - bearertokenauth/dash0
      - health_check
    pipelines:
      traces:
        receivers:
          - otlp
        processors:
          - filter/healthcheck
          - batch
        exporters:
          - otlp/dash0
          - otlphttp/openlit
          - debug
      logs:
        receivers:
          - otlp
        processors:
          - batch
        exporters:
          - otlp/dash0
          - otlphttp/openlit
          - debug
      metrics:
        receivers:
          - otlp
        processors:
          - batch
        exporters:
          - otlp/dash0
          - otlphttp/openlit
          - debug
