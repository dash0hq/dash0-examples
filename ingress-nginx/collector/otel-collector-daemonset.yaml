mode: daemonset
image:
  repository: otel/opentelemetry-collector-contrib

resources:
  limits:
    memory: 512Mi
  requests:
    memory: 256Mi

extraEnvs:
  - name: DASH0_AUTH_TOKEN
    valueFrom:
      secretKeyRef:
        name: dash0-secrets
        key: dash0-authorization-token
  - name: DASH0_ENDPOINT_OTLP_GRPC_HOSTNAME
    valueFrom:
      secretKeyRef:
        name: dash0-secrets
        key: dash0-grpc-hostname
  - name: DASH0_ENDPOINT_OTLP_GRPC_PORT
    valueFrom:
      secretKeyRef:
        name: dash0-secrets
        key: dash0-grpc-port

clusterRole:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["nodes/proxy"]
      verbs: ["get"]

tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

presets:
  logsCollection:
    enabled: true
  kubernetesAttributes:
    enabled: true
  kubeletMetrics:
    enabled: true
  hostMetrics:
    enabled: true

config:
  processors:
    # Transform processor to set trace_id and span_id using proper OTTL functions
    transform/trace-extract:
      log_statements:
        - context: log
          statements:
            # Extract trace_id from plain text log using Split and set the string representation
            - set(trace_id.string, Split(Split(body, "trace_id=")[1], " ")[0]) where IsString(body) and IsMatch(body, ".*trace_id=[a-f0-9]+.*") and Len(Split(body, "trace_id=")) > 1 and Len(Split(Split(body, "trace_id=")[1], " ")) > 0
            # Extract span_id from plain text log using Split and set the string representation
            - set(span_id.string, Split(Split(body, "span_id=")[1], " ")[0]) where IsString(body) and IsMatch(body, ".*span_id=[a-f0-9]+.*") and Len(Split(body, "span_id=")) > 1 and Len(Split(Split(body, "span_id=")[1], " ")) > 0

    k8sattributes:
      extract:
        metadata:
          - k8s.namespace.name
          - k8s.deployment.name
          - k8s.replicaset.name
          - k8s.statefulset.name
          - k8s.daemonset.name
          - k8s.cronjob.name
          - k8s.job.name
          - k8s.node.name
          - k8s.pod.name
          - k8s.pod.uid
          - k8s.pod.start_time
          - k8s.container.name
        # Disabled labels/annotations to avoid OpenSearch mapping conflicts
        # labels:
        #   - from: pod
        #     key_regex: (.*)
        #     tag_name: k8s.pod.label.$${1}
        # annotations:
        #   - from: pod
        #     key_regex: (.*)
        #     tag_name: k8s.pod.annotation.$${1}
      filter:
        node_from_env_var: K8S_NODE_NAME
      passthrough: false
      pod_association:
        - sources:
          - from: resource_attribute
            name: k8s.pod.ip
        - sources:
          - from: resource_attribute
            name: k8s.pod.uid
        - sources:
          - from: connection

  receivers:
    kubeletstats:
      insecure_skip_verify: true # For testing purposes. Remove for production.
      metrics:
        container.cpu.utilization:
          enabled: false
        k8s.node.cpu.utilization:
          enabled: false
        k8s.pod.cpu.utilization:
          enabled: false
        container.cpu.usage:
          enabled: true
        k8s.node.cpu.usage:
          enabled: true
        k8s.pod.cpu.usage:
          enabled: true
        k8s.pod.cpu_limit_utilization:
          enabled: true
        k8s.pod.cpu_request_utilization:
          enabled: true
        k8s.pod.memory_limit_utilization:
          enabled: true
        k8s.pod.memory_request_utilization:
          enabled: true

  exporters:
    otlp/dash0:
      auth:
        authenticator: bearertokenauth/dash0
      endpoint: ${env:DASH0_ENDPOINT_OTLP_GRPC_HOSTNAME}:${env:DASH0_ENDPOINT_OTLP_GRPC_PORT}

    # OpenSearch exporter (local logs)
    opensearch/log:
      http:
        endpoint: https://opensearch-cluster-master.default.svc.cluster.local:9200
        auth:
          authenticator: basicauth/opensearch
        tls:
          insecure_skip_verify: true
      logs_index: otel-logs

  extensions:
    bearertokenauth/dash0:
      scheme: Bearer
      token: ${env:DASH0_AUTH_TOKEN}

    basicauth/opensearch:
      client_auth:
        username: admin
        password: "SecureP@ssw0rd123"

  service:
    extensions:
      - bearertokenauth/dash0
      - basicauth/opensearch
      - health_check
    pipelines:
      logs:
        processors:
          - k8sattributes
          - transform/trace-extract
        exporters:
          - otlp/dash0
          - opensearch/log
      metrics:
        exporters:
          - otlp/dash0
      traces:
        exporters:
          - otlp/dash0