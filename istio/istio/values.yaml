# Istio Helm Values for OpenTelemetry Integration
# Install using Helm charts

global:
  # Istio control plane configuration
  istioNamespace: istio-system

# Istiod (control plane) configuration
pilot:
  traceSampling: 100.0
  resources:
    requests:
      cpu: 200m
      memory: 200Mi
    limits:
      memory: 2Gi

# Mesh configuration
meshConfig:
  # Enable distributed tracing (required even when using Telemetry API)
  enableTracing: true
  defaultConfig:
    # Enable access logging with JSON format
    accessLogFile: /dev/stdout
    accessLogEncoding: JSON
    accessLogFormat: |
      {
        "timestamp": "%START_TIME%",
        "duration": "%DURATION%",
        "protocol": "%PROTOCOL%",
        "response_code": "%RESPONSE_CODE%",
        "response_flags": "%RESPONSE_FLAGS%",
        "bytes_received": "%BYTES_RECEIVED%",
        "bytes_sent": "%BYTES_SENT%",
        "method": "%REQ(:METHOD)%",
        "path": "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%",
        "upstream_service_time": "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%",
        "x_forwarded_for": "%REQ(X-FORWARDED-FOR)%",
        "user_agent": "%REQ(USER-AGENT)%",
        "request_id": "%REQ(X-REQUEST-ID)%",
        "authority": "%REQ(:AUTHORITY)%",
        "upstream_host": "%UPSTREAM_HOST%",
        "upstream_cluster": "%UPSTREAM_CLUSTER%",
        "upstream_local_address": "%UPSTREAM_LOCAL_ADDRESS%",
        "downstream_local_address": "%DOWNSTREAM_LOCAL_ADDRESS%",
        "downstream_remote_address": "%DOWNSTREAM_REMOTE_ADDRESS%",
        "requested_server_name": "%REQUESTED_SERVER_NAME%",
        "route_name": "%ROUTE_NAME%",
        "trace_id": "%REQ(X-B3-TRACEID)%",
        "span_id": "%REQ(X-B3-SPANID)%",
        "parent_span_id": "%REQ(X-B3-PARENTSPANID)%"
      }

  # Default providers for metrics
  defaultProviders:
    metrics:
    - prometheus

  # Extension providers for OpenTelemetry
  extensionProviders:
  - name: otel
    opentelemetry:
      service: opentelemetry/otel-collector-opentelemetry-collector.opentelemetry.svc.cluster.local
      port: 4317
      resource_detectors:
        environment: {}
  - name: otel-access-logging
    envoyOtelAls:
      service: opentelemetry/otel-collector-opentelemetry-collector.opentelemetry.svc.cluster.local
      port: 4317
      resourceDetectors:
        environment: {}

# Ingress Gateway configuration
ingressGateways:
- name: istio-ingressgateway
  enabled: true
  k8s:
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 512Mi
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "15020"
      prometheus.io/path: "/stats/prometheus"
    service:
      type: NodePort
      ports:
      - name: http2
        port: 80
        targetPort: 8080
        nodePort: 30080
      - name: https
        port: 443
        targetPort: 8443
        nodePort: 30443
