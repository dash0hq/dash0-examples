receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  tail_sampling:
    # How long to wait for all spans of a trace before making a decision
    decision_wait: 5s
    # Max number of traces to keep in memory while waiting
    num_traces: 1000

    policies:
      # ========================================
      # POLICY GROUP: error-sampling
      # ========================================
      # Composite policy that samples traces with ERROR status
      # AND have policy.group="error-sampling" resource attribute
      - name: error-traces-policy
        type: and
        and:
          and_sub_policy:
            # Check for error status
            - name: has-error-status
              type: status_code
              status_code:
                status_codes: [ "ERROR" ]
            # Check for policy group attribute
            - name: error-sampling-group
              type: string_attribute
              string_attribute:
                key: policy.group
                values: ["error-sampling"]
                enabled_regex_matching: false

      # ========================================
      # POLICY GROUP: latency-sampling
      # ========================================
      # Composite policy that samples traces with high latency
      # AND have policy.group="latency-sampling" resource attribute
      - name: slow-traces-policy
        type: and
        and:
          and_sub_policy:
            # Check for high latency
            - name: has-high-latency
              type: latency
              latency:
                threshold_ms: 1000
            # Check for policy group attribute
            - name: latency-sampling-group
              type: string_attribute
              string_attribute:
                key: policy.group
                values: ["latency-sampling"]
                enabled_regex_matching: false

      # ========================================
      # POLICY GROUP: probabilistic-sampling
      # ========================================
      # Samples 50% of traces with policy.group="probabilistic-sampling"
      - name: probabilistic-policy
        type: and
        and:
          and_sub_policy:
            # Sample 50% of traces
            - name: probabilistic-50-percent
              type: probabilistic
              probabilistic:
                sampling_percentage: 50
            # Check for policy group attribute
            - name: probabilistic-sampling-group
              type: string_attribute
              string_attribute:
                key: policy.group
                values: ["probabilistic-sampling"]
                enabled_regex_matching: false

  batch: {}
  filter:
    error_mode: ignore
    metrics:
      datapoint:
        - 'IsMatch(ConvertCase(String(metric.name), "lower"), "^k8s\\.replicaset\\.")'
    traces:
      span:
        - 'span.name == "drop me"'
  transform:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          - set(log.observed_time, Now()) where log.observed_time_unix_nano == 0
          - set(log.time, log.observed_time) where log.time_unix_nano == 0

exporters:
  otlp/dash0:
    endpoint: ${env:DASH0_ENDPOINT_OTLP_GRPC_HOSTNAME}:${env:DASH0_ENDPOINT_OTLP_GRPC_PORT}
    headers:
      Authorization: Bearer ${env:DASH0_AUTH_TOKEN}
      Dash0-Dataset: ${env:DASH0_DATASET}
  debug:
    verbosity: detailed

service:
  telemetry:
    logs:
      level: ${env:OPENTELEMETRY_COLLECTOR_LOG_LEVEL}
  pipelines:
    logs:
      receivers:
        - otlp
      exporters:
        - debug
        - otlp/dash0
    traces:
      receivers:
        - otlp
      processors:
        - tail_sampling
        - filter
        - transform
        - batch
      exporters:
        - debug
        - otlp/dash0
    metrics:
      receivers:
        - otlp
      processors:
        - filter
        - transform
        - batch
      exporters:
        - debug
        - otlp/dash0